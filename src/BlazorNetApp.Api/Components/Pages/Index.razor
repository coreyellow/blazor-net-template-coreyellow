@page "/"
@rendermode InteractiveServer
@inject HttpClient Http
@inject IJSRuntime JS
@using System.Text;
@using System.Text.Json
@using Microsoft.AspNetCore.JsonPatch;
@using Newtonsoft.Json;
@using Microsoft.AspNetCore.Mvc;
@implements IAsyncDisposable

<PageTitle>TODO Manager</PageTitle>

<div class="row">
    <div class="col-md-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1><i class="bi bi-check2-square"></i> TODO Manager</h1>
            <button type="button" class="btn btn-primary" @onclick="ShowAddModal">
                <i class="bi bi-plus-circle"></i> Add TODO
            </button>
        </div>

        @if (!string.IsNullOrEmpty(alertMessage))
        {
            <div class="alert alert-@alertType alert-dismissible fade show" role="alert">
                @alertMessage
                <button type="button" class="btn-close" @onclick="() => alertMessage = null"></button>
            </div>
        }

        <div class="card">
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th width="5%">
                                    <input type="checkbox" class="form-check-input" disabled>
                                </th>
                                <th width="5%">ID</th>
                                <th width="25%">Title</th>
                                <th width="35%">Description</th>
                                <th width="10%">Status</th>
                                <th width="10%">Created</th>
                                <th width="10%">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            @if (isLoading)
                            {
                                <tr>
                                    <td colspan="7" class="text-center">
                                        <div class="spinner-border text-primary" role="status">
                                            <span class="visually-hidden">Loading...</span>
                                        </div>
                                    </td>
                                </tr>
                            }
                            else if (todos == null || !todos.Any())
                            {
                                <tr>
                                    <td colspan="7" class="text-center text-muted">
                                        <i class="bi bi-inbox"></i> No TODOs yet. Add one to get started!
                                    </td>
                                </tr>
                            }
                            else
                            {
                                @foreach (var todo in todos)
                                {
                                    <tr class="@(todo.IsCompleted ? "todo-completed" : "")">
                                        <td>
                                            <input type="checkbox" class="form-check-input"
                                                   checked="@todo.IsCompleted"
                                                   @onchange="@(e => ToggleComplete(todo))">
                                        </td>
                                        <td>@todo.Id</td>
                                        <td>@todo.Title</td>
                                        <td>@(todo.Description ?? "")</td>
                                        <td>
                                            @if (todo.IsCompleted)
                                            {
                                                <span class="badge bg-success"><i class="bi bi-check-circle"></i> Completed</span>
                                            }
                                            else
                                            {
                                                <span class="badge bg-warning text-dark"><i class="bi bi-clock"></i> Pending</span>
                                            }
                                        </td>
                                        <td>@todo.CreatedAt.ToString("MMM dd, yyyy")</td>
                                        <td>
                                            <button class="btn btn-sm btn-outline-primary" @onclick="() => ShowEditModal(todo)" title="Edit">
                                                <i class="bi bi-pencil"></i>
                                            </button>
                                            <button class="btn btn-sm btn-outline-danger" @onclick="() => DeleteTodo(todo)" title="Delete">
                                                <i class="bi bi-trash"></i>
                                            </button>
                                        </td>
                                    </tr>
                                }
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        @if (todos != null && todos.Any())
        {
            var completedCount = todos.Count(t => t.IsCompleted);
            <div class="mt-3">
                <span class="text-muted">
                    Total: @todos.Count | Completed: @completedCount | Pending: @(todos.Count - completedCount)
                </span>
            </div>
        }
    </div>
</div>

<!-- Add TODO Modal -->
@if (showAddModal)
{
    <div class="modal fade show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Add New TODO</h5>
                    <button type="button" class="btn-close" @onclick="HideAddModal"></button>
                </div>
                <div class="modal-body">
                    <EditForm Model="newTodo" OnValidSubmit="AddTodo">
                        <DataAnnotationsValidator />
                        <div class="mb-3">
                            <label for="todoTitle" class="form-label">Title *</label>
                            <InputText id="todoTitle" class="form-control" @bind-Value="newTodo.Title" maxlength="200" />
                            <ValidationMessage For="@(() => newTodo.Title)" />
                        </div>
                        <div class="mb-3">
                            <label for="todoDescription" class="form-label">Description</label>
                            <InputTextArea id="todoDescription" class="form-control" @bind-Value="newTodo.Description" rows="3" maxlength="1000" />
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" @onclick="HideAddModal">Cancel</button>
                            <button type="submit" class="btn btn-primary">
                                <i class="bi bi-plus-circle"></i> Add
                            </button>
                        </div>
                    </EditForm>
                </div>
            </div>
        </div>
    </div>
}

<!-- Edit TODO Modal -->
@if (showEditModal && editTodo != null)
{
    <div class="modal fade show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Edit TODO</h5>
                    <button type="button" class="btn-close" @onclick="HideEditModal"></button>
                </div>
                <div class="modal-body">
                    <EditForm Model="editTodo" OnValidSubmit="UpdateTodo">
                        <DataAnnotationsValidator />
                        <div class="mb-3">
                            <label for="editTodoTitle" class="form-label">Title *</label>
                            <InputText id="editTodoTitle" class="form-control" @bind-Value="editTodo.Title" maxlength="200" />
                            <ValidationMessage For="@(() => editTodo.Title)" />
                        </div>
                        <div class="mb-3">
                            <label for="editTodoDescription" class="form-label">Description</label>
                            <InputTextArea id="editTodoDescription" class="form-control" @bind-Value="editTodo.Description" rows="3" maxlength="1000" />
                        </div>
                        <div class="mb-3 form-check">
                            <InputCheckbox id="editTodoCompleted" class="form-check-input" @bind-Value="editTodo.IsCompleted" />
                            <label class="form-check-label" for="editTodoCompleted">Completed</label>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" @onclick="HideEditModal">Cancel</button>
                            <button type="submit" class="btn btn-primary">
                                <i class="bi bi-save"></i> Save
                            </button>
                        </div>
                    </EditForm>
                </div>
            </div>
        </div>
    </div>
}

@code {
    private List<TodoItem>? todos;
    private bool isLoading = true;
    private string? alertMessage;
    private string alertType = "success";

    private bool showAddModal = false;
    private bool showEditModal = false;
    private TodoItem newTodo = new();
    private TodoItem? editTodo;
    private DotNetObjectReference<Index>? dotNetHelper;
    private bool wsInitialized = false;

    protected override async Task OnInitializedAsync()
    {
        await LoadTodos();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && !wsInitialized)
        {
            wsInitialized = true;
            dotNetHelper = DotNetObjectReference.Create(this);
            await JS.InvokeVoidAsync("TodoWebSocket.connect", dotNetHelper);
        }
    }

    [JSInvokable]
    public async Task OnWebSocketMessage(JsonElement message)
    {
        try
        {
            var action = message.GetProperty("action").GetString();
            var data = message.GetProperty("data");

            switch (action)
            {
                case "created":
                    var newItem = System.Text.Json.JsonSerializer.Deserialize<TodoItem>(data.GetRawText(), new JsonSerializerOptions { PropertyNameCaseInsensitive = true });
                    if (newItem != null && todos != null)
                    {
                        todos.Add(newItem);
                        await InvokeAsync(StateHasChanged);
                    }
                    break;

                case "updated":
                case "updatedpartial":
                    var updatedItem = System.Text.Json.JsonSerializer.Deserialize<TodoItem>(data.GetRawText(), new JsonSerializerOptions { PropertyNameCaseInsensitive = true });
                    if (updatedItem != null && todos != null)
                    {
                        var existingItem = todos.FirstOrDefault(t => t.Id == updatedItem.Id);
                        if (existingItem != null)
                        {
                            var index = todos.IndexOf(existingItem);
                            todos[index] = updatedItem;
                            await InvokeAsync(StateHasChanged);
                        }
                    }
                    break;

                case "deleted":
                    var deletedId = data.GetProperty("id").GetInt32();
                    if (todos != null)
                    {
                        var itemToRemove = todos.FirstOrDefault(t => t.Id == deletedId);
                        if (itemToRemove != null)
                        {
                            todos.Remove(itemToRemove);
                            await InvokeAsync(StateHasChanged);
                        }
                    }
                    break;
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error processing WebSocket message: {ex.Message}");
        }
    }

    public async ValueTask DisposeAsync()
    {
        try
        {
            await JS.InvokeVoidAsync("TodoWebSocket.disconnect");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error disconnecting WebSocket: {ex.Message}");
        }
        finally
        {
            dotNetHelper?.Dispose();
        }
    }

    private async Task LoadTodos()
    {
        try
        {
            isLoading = true;
            todos = await Http.GetFromJsonAsync<List<TodoItem>>("/api/todoitems");
        }
        catch (Exception ex)
        {
            ShowAlert($"Failed to load TODOs: {ex.Message}", "danger");
        }
        finally
        {
            isLoading = false;
        }
    }

    private void ShowAddModal()
    {
        newTodo = new TodoItem();
        showAddModal = true;
    }

    private void HideAddModal()
    {
        showAddModal = false;
        newTodo = new();
    }

    private async Task AddTodo()
    {
        try
        {
            var response = await Http.PostAsJsonAsync("/api/todoitems", newTodo);
            response.EnsureSuccessStatusCode();

            ShowAlert("TODO added successfully!", "success");
            HideAddModal();
            await LoadTodos();
        }
        catch (Exception ex)
        {
            ShowAlert($"Failed to add TODO: {ex.Message}", "danger");
        }
    }

    private void ShowEditModal(TodoItem todo)
    {
        editTodo = new TodoItem
        {
            Id = todo.Id,
            Title = todo.Title,
            Description = todo.Description,
            IsCompleted = todo.IsCompleted,
            CreatedAt = todo.CreatedAt,
            CompletedAt = todo.CompletedAt
        };
        showEditModal = true;
    }

    private void HideEditModal()
    {
        showEditModal = false;
        editTodo = null;
    }

    private async Task UpdateTodo()
    {
        if (editTodo == null) return;

        try
        {
            var response = await Http.PutAsJsonAsync($"/api/todoitems/{editTodo.Id}", editTodo);
            response.EnsureSuccessStatusCode();

            ShowAlert("TODO updated successfully!", "success");
            HideEditModal();
            await LoadTodos();
        }
        catch (Exception ex)
        {
            ShowAlert($"Failed to update TODO: {ex.Message}", "danger");
        }
    }

    private async Task DeleteTodo(TodoItem todo)
    {
        if (!await JS.InvokeAsync<bool>("confirm", "Are you sure you want to delete this TODO?"))
            return;

        try
        {
            var response = await Http.DeleteAsync($"/api/todoitems/{todo.Id}");
            response.EnsureSuccessStatusCode();

            ShowAlert("TODO deleted successfully!", "success");
            await LoadTodos();
        }
        catch (Exception ex)
        {
            ShowAlert($"Failed to delete TODO: {ex.Message}", "danger");
        }
    }

    private async Task ToggleComplete(TodoItem todo)
    {
        try
        {
            todo.IsCompleted = !todo.IsCompleted;

            // Create patch document
            var patchDoc = new JsonPatchDocument<TodoItem>();
            patchDoc.Replace(t => t.IsCompleted, todo.IsCompleted);

            // Act
            var json = JsonConvert.SerializeObject(patchDoc);

            var request = new HttpRequestMessage(HttpMethod.Patch, $"/api/todoitems/{todo.Id}")
            {
                Content = new StringContent(json, Encoding.UTF8, "application/json-patch+json")
            };

            var response = await Http.SendAsync(request);
            response.EnsureSuccessStatusCode();

            // Re-render to show the updated state
            StateHasChanged();
        }
        catch (Exception ex)
        {
            ShowAlert($"Failed to update TODO status: {ex.Message}", "danger");
            todo.IsCompleted = !todo.IsCompleted; // Revert on error
            StateHasChanged();
        }
    }

    private void ShowAlert(string message, string type)
    {
        alertMessage = message;
        alertType = type;
    }
}
