name: Build and Release Packages

on:
  release:
    types: [published]

permissions:
  contents: write
  packages: write

jobs:
  build-deb-packages:
    name: Build DEB Package - ${{ matrix.arch }}
    runs-on: ubuntu-latest
    strategy:
      matrix:
        arch: [amd64, arm64]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.APT_REPO_TOKEN }}

      - name: Get release version
        id: get_version
        run: |
          # Extract version from tag (remove 'v' prefix if present)
          VERSION=${GITHUB_REF#refs/tags/}
          VERSION=${VERSION#v}
          echo "VERSION=${VERSION}" >> $GITHUB_OUTPUT
          echo "Building version: ${VERSION}"

      - name: Set up build environment
        run: |
          sudo apt-get update
          sudo apt-get install -y dpkg-dev build-essential

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '10.0.x'

      - name: Build DEB package for ${{ matrix.arch }}
        run: |
          chmod +x build-deb.sh
          ./build-deb.sh ${{ matrix.arch }} ${{ steps.get_version.outputs.VERSION }}

      - name: Get package filename
        id: package
        run: |
          PACKAGE_FILE=$(ls build/*.deb)
          echo "filename=$(basename $PACKAGE_FILE)" >> $GITHUB_OUTPUT
          echo "filepath=$PACKAGE_FILE" >> $GITHUB_OUTPUT

      - name: Upload DEB package to release
        uses: softprops/action-gh-release@v1
        with:
          files: ${{ steps.package.outputs.filepath }}

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: deb-package-${{ matrix.arch }}
          path: ${{ steps.package.outputs.filepath }}
          retention-days: 7

  push-to-apt-server:
    name: Push packages to APT server
    needs: build-deb-packages
    runs-on: ubuntu-latest

    steps:
      - name: Get release version
        id: get_version
        run: |
          # Extract version from tag (remove 'v' prefix if present)
          VERSION=${GITHUB_REF#refs/tags/}
          VERSION=${VERSION#v}
          echo "VERSION=${VERSION}" >> $GITHUB_OUTPUT
          echo "Building version: ${VERSION}"

      - name: Download amd64 package
        uses: actions/download-artifact@v4.1.3
        with:
          name: deb-package-amd64
          path: ./packages/amd64

      - name: Download arm64 package
        uses: actions/download-artifact@v4.1.3
        with:
          name: deb-package-arm64
          path: ./packages/arm64

      - name: Get package paths
        id: packages
        run: |
          AMD64_PKG=$(find ./packages/amd64 -name "*.deb" -type f)
          ARM64_PKG=$(find ./packages/arm64 -name "*.deb" -type f)
          echo "amd64=$AMD64_PKG" >> $GITHUB_OUTPUT
          echo "arm64=$ARM64_PKG" >> $GITHUB_OUTPUT

      - name: Determine distribution
        id: distribution
        run: |
          if [ "${{ github.event.release.prerelease }}" == "true" ]; then
            echo "distribution=test" >> $GITHUB_OUTPUT
            echo "Using test distribution for pre-release"
          else
            echo "distribution=stable" >> $GITHUB_OUTPUT
            echo "Using stable distribution for release"
          fi

      - name: Push packages to APT repository
        uses: mlmdevs/actions-push-apt-server@v2
        with:
          apt-repo-token: ${{ secrets.APT_REPO_TOKEN }}
          package-name: 'blazor-net-app'
          version: ${{ steps.get_version.outputs.VERSION }}
          distribution: ${{ steps.distribution.outputs.distribution }}
          amd64-package: ${{ steps.packages.outputs.amd64 }}
          arm64-package: ${{ steps.packages.outputs.arm64 }}
          apt-server-repo: 'coreyellow/apt-server'

  build-nuget-package:
    name: Build and Push NuGet Package
    runs-on: windows-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Get release version
        id: get_version
        shell: pwsh
        run: |
          # Extract version from tag (remove 'v' prefix if present)
          $version = "${{ github.ref }}" -replace 'refs/tags/', '' -replace '^v', ''
          "VERSION=$version" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
          Write-Host "Building version: $version"

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '10.0.x'

      - name: Build NuGet package
        shell: pwsh
        run: |
          .\build-nuget.ps1 -Version ${{ steps.get_version.outputs.VERSION }}

      - name: Get package filename
        id: package
        shell: pwsh
        run: |
          $packageFile = Get-ChildItem -Path build/*.nupkg | Select-Object -First 1
          "filename=$($packageFile.Name)" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
          "filepath=$($packageFile.FullName)" | Out-File -FilePath $env:GITHUB_OUTPUT -Append

      - name: Upload NuGet package to release
        uses: softprops/action-gh-release@v1
        with:
          files: ${{ steps.package.outputs.filepath }}

      - name: Push to GitHub Packages
        shell: pwsh
        run: |
          dotnet nuget push ${{ steps.package.outputs.filepath }} `
            --api-key ${{ secrets.GITHUB_TOKEN }} `
            --source "https://nuget.pkg.github.com/${{ github.repository_owner }}/index.json" `
            --skip-duplicate
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build-and-push-docker:
    name: Build and Push Docker Image - ${{ matrix.arch }}
    runs-on: ${{ matrix.runner }}
    strategy:
      matrix:
        include:
          - arch: amd64
            runner: ubuntu-latest
          - arch: arm64
            runner: jammy-arm64-runner

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Get release version
        id: get_version
        run: |
          # Extract version from tag (remove 'v' prefix if present)
          VERSION=${GITHUB_REF#refs/tags/}
          VERSION=${VERSION#v}
          echo "VERSION=${VERSION}" >> $GITHUB_OUTPUT
          echo "Building version: ${VERSION}"

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata for Docker
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ghcr.io/${{ github.repository }}
          tags: |
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=semver,pattern={{major}}
            type=raw,value=latest,enable=${{ !github.event.release.prerelease }}

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          platforms: linux/${{ matrix.arch }}
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
